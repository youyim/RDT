#!/bin/sh

# ‰øùÂ≠òÈ°πÁõÆÊ†πÁõÆÂΩï
PROJECT_ROOT=$(pwd)

# Ê£ÄÊµãÂèòÊõ¥ËåÉÂõ¥
FE_CHANGES=$(git diff --name-only --staged | grep "^rdt-frontend/" | wc -l | xargs)
BE_CHANGES=$(git diff --name-only --staged | grep "^rdt-backend/" | wc -l | xargs)

if [ "$FE_CHANGES" = "0" ] && [ "$BE_CHANGES" = "0" ]; then
    exit 0
fi

echo "üöÄ Starting RDT Pre-commit Hook (Fail-fast mode)..."

# --- Á¨¨‰∏ÄÈò∂ÊÆµ: Ê†ºÂºèÂåñ‰∏éÈùôÊÄÅÊ£ÄÊü• (ÊúÄÂø´ÔºåÊúÄÂÆπÊòì‰øÆÂ§ç) ---
if [ "$FE_CHANGES" != "0" ]; then
    echo "üì¶ [Frontend] Formatting & Linting..."
    cd rdt-frontend
    if ! npx --no-install lint-staged; then
        echo "‚ùå [Frontend] Lint/Format failed!"
        exit 1
    fi
    cd "$PROJECT_ROOT"
fi

if [ "$BE_CHANGES" != "0" ]; then
    echo "‚òï [Backend] Auto-formatting (spotless:apply)..."
    cd rdt-backend
    if mvn spotless:apply -q; then
        # Ëá™Âä®Â∞ÜÊ†ºÂºèÂåñÂêéÁöÑÂèòÊõ¥Âä†ÂÖ•ÊöÇÂ≠òÂå∫ (‰ªÖÊõ¥Êñ∞Â∑≤ËøΩË∏™ÁöÑÊñá‰ª∂ÔºåÈò≤Ê≠¢ËØØÂä† untracked Êñá‰ª∂)
        cd "$PROJECT_ROOT"
        git add -u rdt-backend
    else
        echo "‚ùå [Backend] Format application failed!"
        exit 1
    fi
    cd "$PROJECT_ROOT"
fi

# --- Á¨¨‰∫åÈò∂ÊÆµ: ÈÄªËæëÊ†°È™å (ÊµãËØï) ---
if [ "$FE_CHANGES" != "0" ]; then
    cd rdt-frontend
    STAGED_FILES=$(git diff --name-only --staged -- "src/**")
    if [ -n "$STAGED_FILES" ]; then
        echo "üì¶ [Frontend] Running related tests..."
        if ! npx vitest related --run $STAGED_FILES; then
            echo "‚ùå [Frontend] Tests failed!"
            exit 1
        fi
    fi
    cd "$PROJECT_ROOT"

    
    echo "üåç [Frontend] Checking unused i18n keys..."
    cd rdt-frontend
    if ! npm run i18n:check; then
        echo "‚ùå [Frontend] Unused i18n keys found!"
        exit 1
    fi
    
    echo "üåç [Frontend] Verifying i18n keys alignment..."
    if ! npm run i18n:compare; then
        echo "‚ùå [Frontend] I18n keys mismatch!"
        exit 1
    fi
    cd "$PROJECT_ROOT"
fi

if [ "$BE_CHANGES" != "0" ]; then
    echo "‚òï [Backend] Running tests & Architecture checks..."
    cd rdt-backend
    if ! mvn test -q; then
        echo "‚ùå [Backend] Tests failed!"
        exit 1
    fi
    cd "$PROJECT_ROOT"
fi

# --- Á¨¨‰∏âÈò∂ÊÆµ: Ê∑±Â±ÇÊûÑÂª∫È™åËØÅ (ÊúÄÊÖ¢) ---
if [ "$FE_CHANGES" != "0" ]; then
    echo "üèóÔ∏è [Frontend] Verifying architecture (Dependency Cruiser)..."
    cd rdt-frontend
    if ! npm run depcruise; then
        echo "‚ùå [Frontend] Architecture check failed!"
        exit 1
    fi
    cd "$PROJECT_ROOT"

    echo "üì¶ [Frontend] Verifying build (Type check & Production build)..."
    cd rdt-frontend
    if ! npm run build >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Build failed, retrying with output to show errors..."
        npm run build
        echo "‚ùå [Frontend] Build failed!"
        exit 1
    fi
    cd "$PROJECT_ROOT"
fi

# --- Á¨¨ÂõõÈò∂ÊÆµ: ÂºÇÊ≠•/ÈùûÈòªÂ°ûÊ£ÄÊü• ---
if [ "$FE_CHANGES" != "0" ]; then
    echo "üîç [Frontend] Checking security dependencies (Non-blocking)..."
    cd rdt-frontend
    npm audit --audit-level=moderate --registry=https://registry.npmjs.org > /dev/null 2>&1 || echo "  ‚ö†Ô∏è  [Frontend] Security vulnerabilities found (see npm audit for details)"
    cd "$PROJECT_ROOT"
fi

echo "‚ú® All checks passed! Committing..."
