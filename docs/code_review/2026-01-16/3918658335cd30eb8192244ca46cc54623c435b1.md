---
docType: CodeReview
version: "1.0.0"
status: completed
created: 2026-01-16
commitId: 3918658335cd30eb8192244ca46cc54623c435b1
reviewer: Antigravity AI
module: RDT Backend (Auth)
changeLog:
  - version: "1.0.0"
    date: 2026-01-16
    changes: Initial Code Review
---

# 代码评审报告 (Code Review Report)

## 📌 基本信息

| 项目         | 内容                            |
| ------------ | ------------------------------- |
| **评审日期** | 2026-01-16                      |
| **关联提交** | `3918658335` (Commit ID)        |
| **评审人员** | Antigravity AI                  |
| **评审模块** | rdt-backend (Auth & Security)   |
| **变更文件** | 30+ Files (Focus on Core Logic) |

---

## 📋 变更概览

本次提交主要构建了后端登录认证模块的基础设施，包括控制器、服务层、JWT 组件、数据库迁移脚本及安全配置。

### 核心变更文件

| 文件                          | 变更类型 | 说明                    |
| ----------------------------- | -------- | ----------------------- |
| `AuthController.java`         | 新增     | 登录/登出接口           |
| `AuthServiceImpl.java`        | 新增     | 认证业务逻辑 (登录校验) |
| `SecurityConfig.java`         | 新增     | Spring Security 配置    |
| `JwtProvider.java`            | 新增     | JWT 生成与解析          |
| `V1.0.0__create_sys_user.sql` | 新增     | 用户表及初始数据        |

---

## ❌ 存在的问题与建议

### 问题 1: [Security] 缺失 JWT 过滤器配置

- **严重程度**: 🔴 严重
- **所在位置**: `SecurityConfig.java`
- **问题描述**:
  `SecurityConfig` 中配置了 `anyRequest().authenticated()`，但未添加 JWT 认证过滤器 (`JwtAuthenticationFilter`)。这意味着后续受保护的接口将无法通过 JWT Token 进行鉴权，导致所有请求被拒绝（403 Forbidden）或退化为无认证状态。
- **修改建议**:
  实现 `JwtAuthenticationFilter` 并在 `securityFilterChain` 中通过 `http.addFilterBefore(...)` 添加到 `UsernamePasswordAuthenticationFilter` 之前。

**建议修改**:

```java
// SecurityConfig.java
http.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
```

### 问题 2: [Architecture] Service 层缺失事务控制

- **严重程度**: 🔴 严重
- **所在位置**: `AuthServiceImpl.java`
- **问题描述**:
  `AuthServiceImpl` 类或其方法 (`login`, `verifyPassword`) 未添加 `@Transactional` 注解。`login` 操作涉及多次数据库交互（查询用户、更新失败次数/锁定状态、更新最后登录时间）。若无事务控制，在部分操作失败时可能导致数据不一致。
  符合规范：_事务边界在 Service 层_。
- **修改建议**:
  在类级别或涉及写操作的方法上添加 `@Transactional`。

**建议修改**:

```java
@Service
@RequiredArgsConstructor
@Transactional(rollbackFor = Exception.class) // 添加事务
public class AuthServiceImpl implements AuthService { ... }
```

### 问题 3: [Code Quality] 缺失业务日志

- **严重程度**: 🟡 一般
- **所在位置**: `AuthServiceImpl.java`
- **问题描述**:
  业务逻辑中未包含任何日志记录 (`@Slf4j`)。对于认证模块，记录关键事件（如登录失败、账户锁定、异常发生）对安全审计和排错至关重要。
- **修改建议**:
  引入 `@Slf4j` 并记录关键路径日志。

**建议修改**:

```java
@Slf4j
public class AuthServiceImpl ... {
    // ...
    if (user == null) {
        log.warn("Login failed: username {} not found", req.getUsername());
        throw new BusinessException(...);
    }
}
```

### 问题 4: [Standards] 使用遗留时间 API

- **严重程度**: 🟢 建议
- **所在位置**: `JwtProvider.java`
- **问题描述**:
  使用了 `java.util.Date`。虽然 `jjwt` 库可能依赖 Date 对象，但项目规范建议使用 `java.time` (JSR-310)。
- **修改建议**:
  建议仅在调用库方法时转换，内部逻辑尽量保持使用 `Instant` 或 `LocalDateTime`。当前通过 `NOPMD` 压制了警告，属于可接受的技术妥协，但需注意。

### 问题 5: [Cleanup] 代码包含 TODO 及硬编码

- **严重程度**: 🟢 建议
- **所在位置**: `AuthController.java`
- **问题描述**:
  L52 `// TODO: 完善登出逻辑` 包含中文注释且功能未完成。
  Exception message 中包含硬编码字符串 (e.g., "Invalid username or password")。
- **修改建议**:
  建议后续完善登出功能，并将错误信息提取到 `messages.properties` 以支持国际化。

---

## 📊 Checklist 检查结果

### 后端 (Java / Spring Boot)

| 检查项     | 结果 | 备注                                         |
| ---------- | ---- | -------------------------------------------- |
| 判空与异常 | ✅   | 使用了 `BusinessException`，未吞没异常       |
| SQL 性能   | ✅   | `sys_user.username` 已建唯一索引             |
| 代码规范   | ⚠️   | 存在 Magic Strings，使用了 `Date` API        |
| 分层架构   | ✅   | Controller -> Service -> Repository 结构清晰 |
| 日志规范   | ❌   | Service 层完全缺失日志                       |
| 事务控制   | ❌   | Service 层缺失 `@Transactional`              |

### 前端 (React / TypeScript)

_不适用 (本次提交仅涉及后端)_

---

## 📈 问题统计

| 严重程度           | 数量 |
| ------------------ | ---- |
| 🔴 严重 (必须修复) | 2    |
| 🟡 一般 (建议修复) | 1    |
| 🟢 建议 (可选优化) | 2    |

---

## ✅ 最终结论

- [ ] **PASS** (符合标准，可合并)
- [x] **REQUEST CHANGES** (需按上述建议修改后再次提交)

### 关键阻解点

必须修复 **JWT Filter 缺失** 和 **事务控制缺失** 问题，否则认证功能不完整且存在数据一致性风险。
